{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-body">
                <h2 class="text-center mb-4">Book Tickets for {{ movie[1] }}</h2>
                <form method="POST" id="bookingForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="theatre_name" class="form-label">Select Theatre</label>
                            <select class="form-select" id="theatre_name" name="theatre_name" required>
                                <option value="">Choose Theatre</option>
                                <option value="Inox">Inox</option>
                                <option value="PVR">PVR</option>
                                <option value="Cinepolis">Cinepolis</option>
                                <option value="IMAX">IMAX</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="show_date" class="form-label">Select Date</label>
                            <input type="date" class="form-control" id="show_date" name="show_date" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="show_time" class="form-label">Select Show Time</label>
                        <select class="form-select" id="show_time" name="show_time" required>
                            <option value="">Choose Time</option>
                            <option value="05:00">05:00</option>
                            <option value="12:00">12:00</option>
                            <option value="13:30">13:30</option>
                            <option value="22:30">22:30</option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <h4>Select Seats</h4>
                        <div class="screen mb-3 text-center">
                            <div class="bg-light text-dark p-2 rounded">SCREEN</div>
                        </div>
                        <div class="seating-grid">
                            {% for row in seat_layout %}
                            <div class="row mb-2">
                                {% for seat in row %}
                                <div class="col">
                                    <div class="seat" data-price="{{ seat.price }}"
                                         onclick="toggleSeat(this)">
                                        {{ seat.label }}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% endfor %}
                        </div>
                        <input type="hidden" name="seats_selected" id="seats_selected">
                    </div>

                    <div class="mb-4">
                        <h4>Snacks</h4>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="popcorn" name="snack_items" value="Popcorn">
                                    <label class="form-check-label" for="popcorn">Popcorn ($10)</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="coke" name="snack_items" value="Coke">
                                    <label class="form-check-label" for="coke">Coke ($10)</label>
                                </div>
                            </div>
                        </div>
                        <div class="mt-2">
                            <label for="snack_quantity" class="form-label">Quantity</label>
                            <input type="number" class="form-control" id="snack_quantity" name="snack_quantity" min="0" value="0">
                        </div>
                    </div>

                    <div class="mb-4">
                        <h4>Booking Summary</h4>
                        <div id="bookingSummary"></div>
                        <input type="hidden" name="total_amount" id="total_amount">
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" name="confirm_booking" class="btn btn-primary">Confirm Booking</button>
                        <button type="submit" name="cancel_booking" class="btn btn-danger">Cancel Booking</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
    .seat {
        background-color: #333;
        color: white;
        padding: 10px;
        text-align: center;
        cursor: pointer;
        border-radius: 5px;
        margin: 2px;
    }
    
    .seat.selected {
        background-color: var(--primary-color);
    }
    
    .seat.occupied {
        background-color: #666;
        cursor: not-allowed;
    }
</style>

<script>
    let selectedSeats = [];
    let totalAmount = 0;

    function toggleSeat(seat) {
        if (seat.classList.contains('occupied')) return;
        
        seat.classList.toggle('selected');
        const seatNumber = seat.textContent.trim();
        const price = parseInt(seat.dataset.price);
        
        if (seat.classList.contains('selected')) {
            selectedSeats.push({ number: seatNumber, price: price });
        } else {
            selectedSeats = selectedSeats.filter(s => s.number !== seatNumber);
        }
        
        updateBookingSummary();
    }

    function updateBookingSummary() {
        const summary = document.getElementById('bookingSummary');
        const snackQuantity = parseInt(document.getElementById('snack_quantity').value) || 0;
        const hasPopcorn = document.getElementById('popcorn').checked;
        const hasCoke = document.getElementById('coke').checked;
        
        let html = '<ul class="list-unstyled">';
        
        // Seat details
        if (selectedSeats.length > 0) {
            html += '<li><strong>Selected Seats:</strong><br>';
            selectedSeats.forEach(seat => {
                html += `${seat.number} ($${seat.price})<br>`;
            });
            html += '</li>';
        }
        
        // Snack details
        if (snackQuantity > 0) {
            html += '<li><strong>Snacks:</strong><br>';
            if (hasPopcorn) html += `Popcorn x${snackQuantity}<br>`;
            if (hasCoke) html += `Coke x${snackQuantity}<br>`;
            html += '</li>';
        }
        
        // Calculate total
        totalAmount = selectedSeats.reduce((sum, seat) => sum + seat.price, 0);
        if (snackQuantity > 0) {
            const snackCount = (hasPopcorn ? 1 : 0) + (hasCoke ? 1 : 0);
            totalAmount += snackCount * 10 * snackQuantity;
        }
        
        html += `<li class="mt-3"><strong>Total Amount: $${totalAmount}</strong></li>`;
        html += '</ul>';
        
        summary.innerHTML = html;
        document.getElementById('total_amount').value = totalAmount;
        document.getElementById('seats_selected').value = JSON.stringify(selectedSeats);
    }

    // Update summary when snack quantity changes
    document.getElementById('snack_quantity').addEventListener('change', updateBookingSummary);
    document.getElementById('popcorn').addEventListener('change', updateBookingSummary);
    document.getElementById('coke').addEventListener('change', updateBookingSummary);
</script>
{% endblock %} 